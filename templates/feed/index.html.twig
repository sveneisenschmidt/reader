{% extends 'base.html.twig' %}

{% block title %}{% if activeItem %}{{ activeItem.title }} | {{ activeItem.source }} | Reader{% elseif activeFeed %}{% for feed in feeds %}{% if feed.sguid == activeFeed %}{{ feed.name }} | Reader{% endif %}{% endfor %}{% else %}Reader{% endif %}{% endblock %}

{% block stylesheets %}
    <style>{{ asset_inline('css/page-feed.css') }}</style>
{% endblock %}

{% block body_class %}{% if app.request.attributes.get('_route') in ['feed_item', 'feed_item_filtered'] %} class="has-active-item"{% endif %}{% endblock %}

{% block keyboard_shortcuts %}
    {% if user_keyboard_shortcuts() %}
    <div class="keyboard-shortcuts">
        {% if activeItem %}
            <span class="shortcut"><span class="key">{{ source('@icons/arrow-up.svg') }}</span> Previous article</span>
            <span class="shortcut"><span class="key">{{ source('@icons/arrow-down.svg') }}</span> Next article</span>
            <span class="shortcut"><span class="key">{{ source('@icons/space.svg') }}</span> Mark as read/unread</span>
            <span class="shortcut"><span class="key">{{ source('@icons/corner-down-left.svg') }}</span> Read original</span>
            <span class="shortcut"><span class="key">Esc</span> Close article</span>
        {% else %}
            <span class="shortcut"><span class="key">Shift</span> + <span class="key">{{ source('@icons/arrow-right-to-line.svg') }}</span> Previous subscription</span>
            <span class="shortcut"><span class="key">{{ source('@icons/arrow-right-to-line.svg') }}</span> Next subscription</span>
            <span class="shortcut"><span class="key">{{ source('@icons/corner-down-left.svg') }}</span> Open first article</span>
        {% endif %}
    </div>
    {% endif %}
{% endblock %}

{% block header_title %}
    {% if activeItem %}
        <a href="{% if activeFeed %}{{ path_with_filters('subscription_show', {sguid: activeFeed}) }}{% else %}{{ path_with_filters('feed_index') }}{% endif %}" class="home">
            <span class="title">Reader</span>
            <span class="back">&larr; Back</span>
        </a>
    {% else %}
        <a href="{{ path_with_filters('feed_index') }}" class="home">Reader</a>
    {% endif %}
{% endblock %}

{% block menu_toggle %}
    <input type="checkbox" id="menu-toggle" class="menu-checkbox">
{% endblock %}

{% block menu_link %}
    <a href="{{ path_with_filters('feed_index') }}" class="feeds-link active">Feeds</a>
{% endblock %}

{% block footer_toggle %}
    <label for="menu-toggle" class="menu-toggle">
        <span class="icon-open">{{ source('@icons/panel-left-open.svg') }}</span>
        <span class="icon-close">{{ source('@icons/panel-left-close.svg') }}</span>
    </label>
{% endblock %}

{% block page_id %}feed{% endblock %}

{% block page_attrs %} data-scroll-container{% endblock %}

{% block main %}
    <aside data-sidebar>
        <ul class="subscription-list">
            <li{% if not activeFeed %} class="active"{% endif %}>
                <a href="{{ path_with_filters('feed_index') }}">All</a>
                {% if allItemsCount > 0 %}<span class="count">{{ allItemsCount }}</span>{% endif %}
            </li>
            {% for folder, folderFeeds in groupedFeeds %}
            <li class="folder">
                <span class="folder-name">{{ folder }}</span>
                <ul class="folder-feeds">
                    {% for feed in folderFeeds|sort((a, b) => a.name|lower <=> b.name|lower) %}
                    <li{% if activeFeed == feed.sguid %} class="active"{% endif %}>
                        <a href="{{ path_with_filters('subscription_show', {sguid: feed.sguid}) }}">{{ feed.name }}</a>
                        {% if feed.count > 0 %}<span class="count">{{ feed.count }}</span>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </li>
            {% endfor %}
            {% for feed in ungroupedFeeds|sort((a, b) => a.name|lower <=> b.name|lower) %}
            <li{% if activeFeed == feed.sguid %} class="active"{% endif %}>
                <a href="{{ path_with_filters('subscription_show', {sguid: feed.sguid}) }}">{{ feed.name }}</a>
                {% if feed.count > 0 %}<span class="count">{{ feed.count }}</span>{% endif %}
            </li>
            {% endfor %}
        </ul>
        <div class="sidebar-filters">
            <div class="filter-group">
                <a href="{{ filter_url({unread: unread ? 0 : 1}) }}" class="filter-toggle{% if unread %} active{% endif %}">{% if unread %}● Show unread (turn off){% else %}○ Show unread{% endif %}</a>
            </div>
            <div class="filter-group">
                <a href="{{ filter_url({limit: 25}) }}" class="filter-limit{% if limit == 25 %} active{% endif %}">{% if limit == 25 %}●{% else %}○{% endif %} 25</a>
                <a href="{{ filter_url({limit: 50}) }}" class="filter-limit{% if limit == 50 %} active{% endif %}">{% if limit == 50 %}●{% else %}○{% endif %} 50</a>
                <a href="{{ filter_url({limit: 0}) }}" class="filter-limit{% if limit == 0 %} active{% endif %}">{% if limit == 0 %}●{% else %}○{% endif %} 99+</a>
            </div>
        </div>
        {% if allItemsCount > 0 %}
        <footer class="sidebar-footer">
            <form action="{% if activeFeed %}{{ path_with_filters('subscription_mark_all_read', {sguid: activeFeed}) }}{% else %}{{ path_with_filters('feed_mark_all_read') }}{% endif %}" method="post" class="inline">
                <input type="hidden" name="_token" value="{{ csrf_token('mark_all_read') }}">
                <button type="submit" class="btn-link">Mark all as read</button>
            </form>
        </footer>
        {% endif %}
    </aside>

    <section data-reading-list{% if activeFeed %} data-subscription="{{ activeFeed }}"{% endif %}{% if not activeItem %} data-full-width{% endif %}>
        {% if items is empty and unread %}
        <div class="feed-empty">No unread items.<br><a href="{{ filter_url({unread: 0}) }}">Show all items</a></div>
        {% endif %}
        {% for item in items %}
        <div class="feed-item{% if activeItem and item.guid == activeItem.guid %} active{% endif %}{% if item.isRead %} read{% endif %}"{% if activeItem and item.guid == activeItem.guid %} data-active="{{ item.guid }}"{% endif %}>
            <a href="{% if activeFeed %}{{ path_with_filters('feed_item_filtered', {sguid: activeFeed, fguid: item.guid}) }}{% else %}{{ path_with_filters('feed_item', {fguid: item.guid}) }}{% endif %}" class="feed-item-link">
                <h2>{% if item.isNew %}<span class="new-indicator">●</span> {% endif %}{{ item.title }}</h2>
                <p class="meta">
                    <span class="source">{{ item.source }}</span>
                    <time datetime="{{ item.date|date('Y-m-d') }}">{% if item.date|date('Y-m-d') == 'now'|date('Y-m-d') %}{{ item.date|date('H:i') }}{% else %}{{ item.date|date('j F Y') }}{% endif %}</time>
                </p>
            </a>

        </div>
        {% endfor %}
    </section>
    <script>{{ asset_inline('js/scroll-restore.js') }}</script>

    {% if activeItem %}
    <article data-reading-pane data-item="{{ activeItem.guid }}"{% if not activeItem.isRead %} data-unread{% endif %}>
        <header>
            <h1><a href="{{ path('feed_item_open', {fguid: activeItem.guid, url: activeItem.link}) }}" target="_blank" rel="noopener noreferrer">{{ activeItem.title }}</a></h1>
            <p class="meta">
                <a href="{{ path_with_filters('subscription_show', {sguid: activeItem.sguid}) }}" class="source">{{ activeItem.source }}</a>
                <time datetime="{{ activeItem.date|date('Y-m-d\\TH:i') }}">{% if activeItem.date|date('Y-m-d') == 'now'|date('Y-m-d') %}{{ activeItem.date|date('H:i') }}{% else %}{{ activeItem.date|date('j F Y, H:i') }}{% endif %}</time>
            </p>
        </header>
        <div class="content">
            {{ activeItem.excerpt|rewrite_links(activeItem.guid)|raw }}
        </div>
        <footer>
            <a href="{{ path('feed_item_open', {fguid: activeItem.guid, url: activeItem.link}) }}" target="_blank" rel="noopener noreferrer" class="btn-link">Read original</a>
            {% if activeItem.isRead %}
                <form action="{% if activeFeed %}{{ path_with_filters('feed_item_filtered_mark_unread', {sguid: activeFeed, fguid: activeItem.guid}) }}{% else %}{{ path_with_filters('feed_item_mark_unread', {fguid: activeItem.guid}) }}{% endif %}" method="post" class="inline" data-form-mark-unread>
                    <input type="hidden" name="_token" value="{{ csrf_token('mark_read') }}">
                    <button type="submit" name="redirect" value="article" class="btn-link" data-mark-action-article>Mark as unread</button>
                    <button type="submit" name="redirect" value="list" class="btn-link" data-mark-action-list>Mark as unread</button>
                </form>
            {% else %}
                <form action="{% if activeFeed %}{{ path_with_filters('feed_item_filtered_mark_read', {sguid: activeFeed, fguid: activeItem.guid}) }}{% else %}{{ path_with_filters('feed_item_mark_read', {fguid: activeItem.guid}) }}{% endif %}" method="post" class="inline" data-form-mark-read>
                    <input type="hidden" name="_token" value="{{ csrf_token('mark_read') }}">
                    <button type="submit" name="redirect" value="article" class="btn-link" data-mark-action-article>Mark as read</button>
                    <button type="submit" name="redirect" value="list" class="btn-link" data-mark-action-list>Mark as read</button>
                </form>
            {% endif %}
        </footer>
    </article>
    {% if user_auto_mark_read() %}
    <script>{{ asset_inline('js/auto-mark-read.js') }}</script>
    {% endif %}
    <script>{{ asset_inline('js/open-link-refresh.js') }}</script>
    {% endif %}

    {% if user_keyboard_shortcuts() %}
    <script>{{ asset_inline('js/keyboard-shortcuts.js') }}</script>
    {% endif %}

    {% if pullToRefresh %}
    <script>{{ asset_inline('js/pull-to-refresh.js') }}</script>
    {% endif %}
{% endblock %}
