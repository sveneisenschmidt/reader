{% extends 'base.html.twig' %}

{% block title %}{% if activeItem %}{{ activeItem.title }} | {{ activeItem.source }} | Reader{% elseif activeFeed %}{% for feed in feeds %}{% if feed.sguid == activeFeed %}{{ feed.name }} | Reader{% endif %}{% endfor %}{% else %}Reader{% endif %}{% endblock %}

{% block preload %}
    <link rel="preload" href="{{ asset('css/page-feed.css') }}" as="style">
{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/page-feed.css') }}">
{% endblock %}

{% block body_class %}{% if app.request.attributes.get('_route') in ['feed_item', 'feed_item_filtered'] %} class="has-active-item"{% endif %}{% endblock %}

{% block menu_toggle %}
    <input type="checkbox" id="menu-toggle" class="menu-checkbox">
{% endblock %}

{% block menu_link %}
    <a href="{{ path_with_filters('feed_index') }}" class="feeds-link active">Feeds</a>
    <label for="menu-toggle" class="menu-toggle">Feeds</label>
{% endblock %}

{% block page_id %}feed{% endblock %}

{% block main %}
    <aside data-sidebar>
        <ul class="subscription-list">
            <li{% if not activeFeed %} class="active"{% endif %}>
                <a href="{{ path_with_filters('feed_index') }}">All</a>
                {% if allItemsCount > 0 %}<span class="count">{{ allItemsCount }}</span>{% endif %}
            </li>
            {% set groupedFeeds = {} %}
            {% set ungroupedFeeds = [] %}
            {% for feed in feeds %}
                {% if feed.folder is not null and feed.folder|length > 0 %}
                    {% set folderKey = feed.folder %}
                    {% if groupedFeeds[folderKey] is not defined %}
                        {% set groupedFeeds = groupedFeeds|merge({(folderKey): {'folder': feed.folder, 'feeds': []}}) %}
                    {% endif %}
                    {% set groupedFeeds = groupedFeeds|merge({(folderKey): {'folder': feed.folder, 'feeds': groupedFeeds[folderKey].feeds|merge([feed])}}) %}
                {% else %}
                    {% set ungroupedFeeds = ungroupedFeeds|merge([feed]) %}
                {% endif %}
            {% endfor %}
            {% for folderKey, group in groupedFeeds %}
            <li class="folder">
                <span class="folder-name">{{ group.folder }}</span>
                <ul class="folder-feeds">
                    {% for feed in group.feeds %}
                    <li{% if activeFeed == feed.sguid %} class="active"{% endif %}>
                        <a href="{{ path_with_filters('subscription_show', {sguid: feed.sguid}) }}">{{ feed.name }}</a>
                        {% if feed.count > 0 %}<span class="count">{{ feed.count }}</span>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </li>
            {% endfor %}
            {% for feed in ungroupedFeeds %}
            <li{% if activeFeed == feed.sguid %} class="active"{% endif %}>
                <a href="{{ path_with_filters('subscription_show', {sguid: feed.sguid}) }}">{{ feed.name }}</a>
                {% if feed.count > 0 %}<span class="count">{{ feed.count }}</span>{% endif %}
            </li>
            {% endfor %}
        </ul>
        <div class="sidebar-filters">
            <div class="filter-group">
                <a href="{{ filter_url({unread: unread ? 0 : 1}) }}" class="filter-toggle{% if unread %} active{% endif %}">{% if unread %}● Show unread (disable){% else %}○ Show unread{% endif %}</a>
            </div>
            <div class="filter-group">
                <a href="{{ filter_url({limit: 25}) }}" class="filter-limit{% if limit == 25 %} active{% endif %}">{% if limit == 25 %}●{% else %}○{% endif %} 25</a>
                <a href="{{ filter_url({limit: 50}) }}" class="filter-limit{% if limit == 50 %} active{% endif %}">{% if limit == 50 %}●{% else %}○{% endif %} 50</a>
                <a href="{{ filter_url({limit: 0}) }}" class="filter-limit{% if limit == 0 %} active{% endif %}">{% if limit == 0 %}●{% else %}○{% endif %} 99+</a>
            </div>
        </div>
        {% if allItemsCount > 0 %}
        <footer class="sidebar-footer">
            <form action="{% if activeFeed %}{{ path_with_filters('subscription_mark_all_read', {sguid: activeFeed}) }}{% else %}{{ path_with_filters('feed_mark_all_read') }}{% endif %}" method="post" class="inline">
                <input type="hidden" name="_token" value="{{ csrf_token('mark_all_read') }}">
                <button type="submit" class="btn-link">Mark all as read</button>
            </form>
        </footer>
        {% endif %}
    </aside>

    <section data-reading-list{% if not activeItem %} data-full-width{% endif %}>
        {% if items is empty and unread %}
        <div class="feed-empty">No unread items</div>
        {% endif %}
        {% for item in items %}
        <div class="feed-item{% if activeItem and item.guid == activeItem.guid %} active{% endif %}{% if item.isRead %} read{% endif %}"{% if activeItem and item.guid == activeItem.guid %} data-active{% endif %}>
            <a href="{% if activeFeed %}{{ path_with_filters('feed_item_filtered', {sguid: activeFeed, fguid: item.guid}) }}{% else %}{{ path_with_filters('feed_item', {fguid: item.guid}) }}{% endif %}" class="feed-item-link">
                <h2>{% if item.isNew %}<span class="new-indicator">●</span> {% endif %}{{ item.title }}</h2>
                <p class="meta">
                    <span class="source">{{ item.source }}</span>
                    <time datetime="{{ item.date|date('Y-m-d') }}">{{ item.date|date('j F Y') }}</time>
                </p>
            </a>

        </div>
        {% endfor %}
    </section>
    <script src="{{ asset('js/scroll-restore.js') }}"></script>

    {% if activeItem %}
    <article data-reading-pane>
        <a href="{% if activeFeed %}{{ path_with_filters('subscription_show', {sguid: activeFeed}) }}{% else %}{{ path_with_filters('feed_index') }}{% endif %}" class="back-link">&larr; Back</a>
        <header>
            <h1><a href="{{ activeItem.link }}" data-external-link>{{ activeItem.title }}</a></h1>
            <p class="meta">
                <a href="{{ path_with_filters('subscription_show', {sguid: activeItem.sguid}) }}" class="source">{{ activeItem.source }}</a>
                <time datetime="{{ activeItem.date|date('Y-m-d\\TH:i') }}">{{ activeItem.date|date('j F Y, H:i') }}</time>
            </p>
        </header>
        <div class="content" data-article-content>
            {{ activeItem.excerpt|raw }}
        </div>
        <footer>
            <form action="{% if activeFeed %}{{ path_with_filters('feed_item_filtered_mark_read_stay', {sguid: activeFeed, fguid: activeItem.guid}) }}{% else %}{{ path_with_filters('feed_item_mark_read_stay', {fguid: activeItem.guid}) }}{% endif %}" method="post" class="inline" data-mark-read-stay-form data-external-url="{{ activeItem.link }}">
                <input type="hidden" name="_token" value="{{ csrf_token('mark_read') }}">
                <button type="submit" class="btn-link" data-external-link>Read original</button>
            </form>
            {% if activeItem.isRead %}
                <form action="{% if activeFeed %}{{ path_with_filters('feed_item_filtered_mark_unread', {sguid: activeFeed, fguid: activeItem.guid}) }}{% else %}{{ path_with_filters('feed_item_mark_unread', {fguid: activeItem.guid}) }}{% endif %}" method="post" class="inline">
                    <input type="hidden" name="_token" value="{{ csrf_token('mark_read') }}">
                    <button type="submit" class="btn-link">Mark as unread</button>
                </form>
            {% else %}
                <form action="{% if activeFeed %}{{ path_with_filters('feed_item_filtered_mark_read', {sguid: activeFeed, fguid: activeItem.guid}) }}{% else %}{{ path_with_filters('feed_item_mark_read', {fguid: activeItem.guid}) }}{% endif %}" method="post" class="inline" data-auto-mark-read-form>
                    <input type="hidden" name="_token" value="{{ csrf_token('mark_read') }}">
                    <input type="hidden" name="stay" value="0" data-auto-mark-read-stay>
                    <button type="submit" class="btn-link">Mark as read</button>
                </form>
            {% endif %}
        </footer>
    </article>
    <script src="{{ asset('js/external-links.js') }}"></script>
    {% if autoMarkAsRead and not activeItem.isRead %}
    <script src="{{ asset('js/auto-mark-read.js') }}"></script>
    {% endif %}
    {% endif %}
    {% if pullToRefresh %}
    <script src="{{ asset('js/pull-to-refresh.js') }}"></script>
    {% endif %}
{% endblock %}
