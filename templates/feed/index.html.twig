{% extends 'base.html.twig' %}

{% block title %}{% if activeItem %}{{ activeItem.title }} | {{ activeItem.source }} | Reader{% elseif activeFeed %}{% for feed in feeds %}{% if feed.sguid == activeFeed %}{{ feed.name }} | Reader{% endif %}{% endfor %}{% else %}Reader{% endif %}{% endblock %}

{% block stylesheets %}
    <style>{{ asset_inline('css/page-feed.css') }}</style>
    <style>{{ asset_inline('css/page-feed-reading-pane.css') }}</style>
{% endblock %}

{% block body_class %}{% if app.request.attributes.get('_route') in ['feed_item', 'feed_item_filtered'] %} class="has-active-item"{% endif %}{% endblock %}

{% block keyboard_shortcuts %}
    {% if user_keyboard_shortcuts() %}
    <div class="keyboard-shortcuts">
        {% if activeItem %}
            <span class="shortcut"><span class="key">{{ source('@icons/arrow-up.svg') }}</span> Previous article</span>
            <span class="shortcut"><span class="key">{{ source('@icons/arrow-down.svg') }}</span> Next article</span>
            <span class="shortcut"><span class="key">{{ source('@icons/space.svg') }}</span> Mark as read/unread</span>
            <span class="shortcut"><span class="key">{{ source('@icons/corner-down-left.svg') }}</span> Read original</span>
            <span class="shortcut"><span class="key">Esc</span> Close article</span>
        {% else %}
            <span class="shortcut"><span class="key">Shift</span> + <span class="key">{{ source('@icons/arrow-right-to-line.svg') }}</span> Previous subscription</span>
            <span class="shortcut"><span class="key">{{ source('@icons/arrow-right-to-line.svg') }}</span> Next subscription</span>
            <span class="shortcut"><span class="key">{{ source('@icons/corner-down-left.svg') }}</span> Open first article</span>
        {% endif %}
    </div>
    {% endif %}
{% endblock %}

{% block header_title %}
    {% if activeItem %}
        <a href="{% if activeFeed %}{{ path_with_filters('subscription_show', {sguid: activeFeed}) }}{% else %}{{ path_with_filters('feed_index') }}{% endif %}" class="home">
            <span class="title">Reader</span>
            <span class="back">&larr; Back</span>
        </a>
    {% else %}
        <a href="{{ path_with_filters('feed_index') }}" class="home">Reader</a>
    {% endif %}
{% endblock %}

{% block menu_toggle %}
    <input type="checkbox" id="menu-toggle" class="menu-checkbox">
{% endblock %}

{% block header_actions %}
    <a href="{{ filter_url({unread: unread ? 0 : 1}) }}" class="icon-btn" title="{{ unread ? 'Show all' : 'Show unread only' }}">
        {{ unread ? source('@icons/eye.svg') : source('@icons/eye-off.svg') }}
    </a>
    <form action="{% if activeFeed %}{{ path_with_filters('subscription_mark_all_read', {sguid: activeFeed}) }}{% else %}{{ path_with_filters('feed_mark_all_read') }}{% endif %}" method="post" class="inline">
        <input type="hidden" name="_token" value="{{ csrf_token('mark_all_read') }}">
        <button type="submit" class="btn-link icon-btn" title="Mark all as read"{% if allItemsCount == 0 %} disabled{% endif %}>
            {{ source('@icons/check-check.svg') }}
        </button>
    </form>
    {% set nextLimit = limit == 25 ? 50 : (limit == 50 ? 0 : 25) %}
    {% set displayLimit = limit == 0 ? '99' : limit %}
    <a href="{{ filter_url({limit: nextLimit}) }}" class="icon-btn limit-toggle" title="Items per page: {{ displayLimit }}">
        {{ source('@icons/hash.svg') }}
        <span class="limit-value">{{ displayLimit }}</span>
    </a>
    <form action="{{ path_with_filters('feed_refresh') }}" method="post" class="inline" data-refresh-form>
        <input type="hidden" name="_token" value="{{ csrf_token('refresh') }}">
        <button type="submit" class="btn-link icon-btn" title="Refresh">{{ source('@icons/refresh-ccw-dot.svg') }}</button>
    </form>
{% endblock %}

{% block footer_toggle %}
    <label for="menu-toggle" class="menu-toggle">
        <span class="icon-open">{{ source('@icons/panel-left-open.svg') }}</span>
        <span class="icon-close">{{ source('@icons/panel-left-close.svg') }}</span>
    </label>
{% endblock %}

{% block page_id %}feed{% endblock %}

{% block page_attrs %} data-scroll-container{% endblock %}

{% block main %}
    <aside data-sidebar>
        <ul class="subscription-list">
            <li{% if not activeFeed and not bookmarksOnly %} class="active"{% endif %}>
                <a href="{{ path_with_filters('feed_index') }}">All</a>
                {% if allItemsCount > 0 %}<span class="count">{{ allItemsCount }}</span>{% endif %}
            </li>
            {% if bookmarksEnabled and bookmarksCount > 0 %}
            <li class="bookmarks{% if bookmarksOnly %} active{% endif %}">
                <a href="{{ path('feed_bookmarks') }}">Bookmarks</a>
                <span class="count">{{ bookmarksCount }}</span>
            </li>
            {% endif %}
            {% for folder, folderFeeds in groupedFeeds %}
            <li class="folder">
                <span class="folder-name">{{ folder }}</span>
                <ul class="folder-feeds">
                    {% for feed in folderFeeds|sort((a, b) => a.name|lower <=> b.name|lower) %}
                    <li{% if activeFeed == feed.sguid %} class="active"{% endif %}>
                        <a href="{{ path_with_filters('subscription_show', {sguid: feed.sguid}) }}">{{ feed.name }}</a>
                        {% if feed.count > 0 %}<span class="count">{{ feed.count }}</span>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </li>
            {% endfor %}
            {% for feed in ungroupedFeeds|sort((a, b) => a.name|lower <=> b.name|lower) %}
            <li{% if activeFeed == feed.sguid %} class="active"{% endif %}>
                <a href="{{ path_with_filters('subscription_show', {sguid: feed.sguid}) }}">{{ feed.name }}</a>
                {% if feed.count > 0 %}<span class="count">{{ feed.count }}</span>{% endif %}
            </li>
            {% endfor %}
        </ul>
        <nav class="sidebar-nav">
            <a href="{{ path('subscriptions') }}" class="sidebar-nav-link{% if app.request.attributes.get('_route') == 'subscriptions' %} active{% endif %}">
                {{ source('@icons/rss.svg') }}
                <span>Subscriptions</span>
            </a>
            <a href="{{ path('preferences') }}" class="sidebar-nav-link{% if app.request.attributes.get('_route') == 'preferences' %} active{% endif %}">
                {{ source('@icons/settings-2.svg') }}
                <span>Settings</span>
            </a>
        </nav>
    </aside>

    <section data-reading-list{% if activeFeed %} data-subscription="{{ activeFeed }}"{% endif %}{% if not activeItem %} data-full-width{% endif %}>
        {% if items is empty and unread %}
        <div class="feed-empty">No unread items.<br><a href="{{ filter_url({unread: 0}) }}">Show all items</a></div>
        {% endif %}
        {% for item in items %}
        <div class="feed-item{% if activeItem and item.guid == activeItem.guid %} active{% endif %}{% if item.isRead %} read{% endif %}"{% if activeItem and item.guid == activeItem.guid %} data-active="{{ item.guid }}"{% endif %}>
            <a href="{% if activeFeed %}{{ path_with_filters('feed_item_filtered', {sguid: activeFeed, fguid: item.guid}) }}{% else %}{{ path_with_filters('feed_item', {fguid: item.guid}) }}{% endif %}" class="feed-item-link">
                <h2>{% if item.isNew %}<span class="new-indicator">‚óè</span> {% endif %}{{ item.title }}</h2>
                <p class="meta">
                    <span class="source">{{ item.source }}</span>
                    <time datetime="{{ item.fetchedAt|date('Y-m-d') }}" title="Published at: {{ item.publishedAt|date('j F Y, H:i') }}">{% if item.fetchedAt|date('Y-m-d') == 'now'|date('Y-m-d') %}{{ item.fetchedAt|date('H:i') }}{% else %}{{ item.fetchedAt|date('j F Y') }}{% endif %}</time>
                </p>
            </a>

        </div>
        {% endfor %}
    </section>
    <script>{{ asset_inline('js/scroll-restore.js') }}</script>

    {% if activeItem %}
    {% include 'feed/_reading-pane.html.twig' with {activeItem: activeItem, activeFeed: activeFeed, bookmarksEnabled: bookmarksEnabled} %}
    {% if user_auto_mark_read() %}
    <script>{{ asset_inline('js/auto-mark-read.js') }}</script>
    {% endif %}
    <script>{{ asset_inline('js/open-link-refresh.js') }}</script>
    {% endif %}

    {% if user_keyboard_shortcuts() %}
    <script>{{ asset_inline('js/keyboard-shortcuts.js') }}</script>
    {% endif %}

    {% if pullToRefresh %}
    <script>{{ asset_inline('js/pull-to-refresh.js') }}</script>
    {% endif %}
{% endblock %}
