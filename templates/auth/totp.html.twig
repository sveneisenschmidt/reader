{% extends 'auth/base.html.twig' %}

{% block title %}Update Authentication | Reader{% endblock %}
{% block header_actions %}Update Authentication{% endblock %}
{% block page_id %}totp{% endblock %}
{% block intro %}Enter your credentials and current verification code, then scan the new QR code and enter the new code.{% endblock %}

{% block form %}
    {{ form_start(form, {'attr': {'class': 'form', 'novalidate': 'novalidate'}}) }}

    <div class="form-row">
        {{ form_label(form.email) }}
        {{ form_widget(form.email, {'attr': {'required': true}}) }}
        {{ form_errors(form.email) }}
    </div>

    <div class="form-row">
        {{ form_label(form.password) }}
        {{ form_widget(form.password, {'attr': {'required': true}}) }}
        {{ form_errors(form.password) }}
    </div>

    <div class="form-row">
        {{ form_label(form.current_otp) }}
        {{ form_widget(form.current_otp, {attr: {class: 'otp-input', maxlength: 6, inputmode: 'numeric', pattern: '[0-9]{6}', autocomplete: 'one-time-code', placeholder: '000000', required: true}}) }}
        {{ form_errors(form.current_otp) }}
    </div>

    <div class="form-row">
        <p>Scan the new QR code with your authenticator app or enter the code manually. Your current code remains valid for up to 60 seconds.</p>
    </div>

    <figure class="qr-code">
        <img src="{{ totp_qr_data_uri }}" alt="QR Code">
        <figcaption><code>{{ totp_secret }}</code></figcaption>
    </figure>

    <div class="form-row">
        {{ form_label(form.new_otp) }}
        {{ form_widget(form.new_otp, {attr: {class: 'otp-input', maxlength: 6, inputmode: 'numeric', pattern: '[0-9]{6}', autocomplete: 'one-time-code', placeholder: '000000', required: true}}) }}
        {{ form_errors(form.new_otp) }}
    </div>

    <button type="submit">Update authentication</button>

    <div class="form-links">
        {% if app.user %}
            <a href="{{ path('preferences') }}">Back to preferences →</a>
        {% else %}
            <a href="{{ path('auth_login') }}">Back to login →</a>
        {% endif %}
    </div>

    {{ form_end(form) }}
{% endblock %}
