name: Deploy

on:
    workflow_dispatch:
        inputs:
            minify_assets:
                description: "Minify CSS and JS assets"
                required: false
                default: true
                type: boolean

jobs:
    # TODO: Re-enable tests before deploy
    # test:
    #     if: github.actor == 'sveneisenschmidt'
    #     uses: ./.github/workflows/tests.yml

    deploy:
        # needs: test
        runs-on: ubuntu-latest
        env:
            APP_ENV: prod

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.4"
                  extensions: ctype, iconv, sqlite3, pdo_sqlite
                  coverage: none

            - name: Install dependencies
              run: composer install --no-dev --no-scripts --optimize-autoloader --no-progress

            - name: Build assets
              run: php bin/console asset-map:compile

            - name: Setup Node.js
              if: ${{ inputs.minify_assets }}
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Minify CSS and JS
              if: ${{ inputs.minify_assets }}
              run: |
                  npm install -g terser cssnano-cli

                  # Minify all JS files in public/assets
                  find public/assets -name "*.js" -type f | while read file; do
                    echo "Minifying JS: $file"
                    terser "$file" --compress --mangle -o "$file"
                  done

                  # Minify all CSS files in public/assets
                  find public/assets -name "*.css" -type f | while read file; do
                    echo "Minifying CSS: $file"
                    cssnano "$file" "$file"
                  done

            - name: Setup SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
                  chmod 600 ~/.ssh/deploy_key
                  ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

            - name: Ensure directories exist on server
              run: |
                  ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
                    "mkdir -p ${{ secrets.DEPLOY_PATH }}/var/data ${{ secrets.DEPLOY_PATH }}/var/share ${{ secrets.DEPLOY_PATH }}/var/log ${{ secrets.DEPLOY_PATH }}/var/cache ${{ secrets.DEPLOY_PATH }}/backup && \
                     chmod -R 775 ${{ secrets.DEPLOY_PATH }}/var && \
                     chmod -R 777 ${{ secrets.DEPLOY_PATH }}/var/cache ${{ secrets.DEPLOY_PATH }}/var/log"

            - name: Backup databases
              run: |
                  ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
                    "cd ${{ secrets.DEPLOY_PATH }}/var/data && for db in *.db; do [ -f \"\$db\" ] && cp \"\$db\" ${{ secrets.DEPLOY_PATH }}/backup/\$(date +%Y%m%d_%H%M%S)_\$db; done || true"

            - name: Deploy via rsync
              run: |
                  rsync -avz --delete \
                    --include='assets/***' \
                    --include='bin/***' \
                    --include='config/***' \
                    --include='importmap.php' \
                    --include='migrations/***' \
                    --include='public/***' \
                    --include='src/***' \
                    --include='templates/***' \
                    --include='translations/***' \
                    --include='vendor/***' \
                    --exclude='*' \
                    -e "ssh -i ~/.ssh/deploy_key" \
                    ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}

            - name: Clear cache
              run: |
                  ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
                    "cd ${{ secrets.DEPLOY_PATH }} && \
                     php bin/console cache:clear"

            - name: Run migrations
              run: |
                  ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
                    "cd ${{ secrets.DEPLOY_PATH }} && \
                     php bin/console doctrine:migrations:migrate --em=users --no-interaction && \
                     php bin/console doctrine:migrations:migrate --em=subscriptions --no-interaction && \
                     php bin/console doctrine:migrations:migrate --em=content --no-interaction && \
                     php bin/console doctrine:migrations:migrate --em=messages --no-interaction"

            - name: Warmup cache
              run: |
                  ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
                    "cd ${{ secrets.DEPLOY_PATH }} && \
                     php bin/console cache:warmup"
